#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#

chart:
  version: 1.2.3
  appVersion: 4.5.6

release:
  name: polaris-release
  namespace: polaris-ns

templates:
  - configmap.yaml

tests:

  # metadata.name
  - it: should set config map name
    asserts:
      - equal:
          path: metadata.name
          value: polaris-release
  - it: should set config map name with override
    set:
      nameOverride: polaris-override
    asserts:
      - equal:
          path: metadata.name
          value: polaris-release-polaris-override
  - it: should set config map name with full override
    set:
      fullnameOverride: polaris-override
    asserts:
      - equal:
          path: metadata.name
          value: polaris-override

  # metadata.namespace
  - it: should set config map namespace
    asserts:
      - equal:
          path: metadata.namespace
          value: polaris-ns

  # metadata.labels
  - it: should set config map default labels
    asserts:
      - isSubset:
          path: metadata.labels
          content:
            app.kubernetes.io/name: polaris
            app.kubernetes.io/instance: polaris-release
            app.kubernetes.io/version: 4.5.6
            app.kubernetes.io/managed-by: Helm
            helm.sh/chart: polaris-1.2.3
  - it: should set include podLabels in deployment labels
    set:
      configMapLabels:
        app.kubernetes.io/component: polaris
    asserts:
      - isSubset:
          path: metadata.labels
          content:
            app.kubernetes.io/component: polaris

  - it: should configure realm context
    set:
      realmContext: { type: "custom", realms: [ "realm1", "realm2" ] }
    asserts:
      - matchRegex: { path: 'data["application.properties"]', pattern: "polaris.realm-context.type=custom" }
      - matchRegex: { path: 'data["application.properties"]', pattern: "polaris.realm-context.realms=realm1,realm2" }

  - it: should configure features
    set:
      features:
        defaults:
          feature1: true
          feature2: 42
        realmOverrides:
          realm1:
            feature1: false
          realm2:
            feature2: 43
    asserts:
      - matchRegex: { path: 'data["application.properties"]', pattern: "polaris.features.defaults.\"feature1\"=true" }
      - matchRegex: { path: 'data["application.properties"]', pattern: "polaris.features.defaults.\"feature2\"=42" }
      - matchRegex: { path: 'data["application.properties"]', pattern: "polaris.config.realm-overrides.\"realm1\".\"feature1\"=false" }
      - matchRegex: { path: 'data["application.properties"]', pattern: "polaris.config.realm-overrides.\"realm2\".\"feature2\"=43" }

  - it: should configure persistence
    set:
      persistence: { type: "eclipse-link", eclipseLink: { persistenceUnit: "polaris", secret: { name: "polaris-persistence" } } }
    asserts:
      - matchRegex: { path: 'data["application.properties"]', pattern: "polaris.persistence.type=eclipse-link" }
      - matchRegex: { path: 'data["application.properties"]', pattern: "polaris.persistence.eclipselink.persistence-unit=polaris" }
      - matchRegex: { path: 'data["application.properties"]', pattern: "polaris.persistence.eclipselink.configuration-file=/deployments/config/persistence.xml" }

  - it: should configure file-io
    set:
      fileIo.type: "custom"
    asserts:
      - matchRegex: { path: 'data["application.properties"]', pattern: "polaris.file-io.type=custom" }

  - it: should configure GCP token lifespan
    set:
      storage: { secret: { gcpTokenLifespan: "PT2H" } }
    asserts:
      - matchRegex: { path: 'data["application.properties"]', pattern: "polaris.storage.gcp.lifespan=PT2H" }

  - it: should configure authentication with RSA key pair
    set:
      authentication: { authenticator: { type: custom }, tokenService: { type: custom }, tokenBroker: { type: rsa-key-pair, maxTokenGeneration: PT2H, secret: { name: polaris-auth } } }
    asserts:
      - matchRegex: { path: 'data["application.properties"]', pattern: "polaris.authentication.authenticator.type=custom" }
      - matchRegex: { path: 'data["application.properties"]', pattern: "polaris.authentication.token-service.type=custom" }
      - matchRegex: { path: 'data["application.properties"]', pattern: "polaris.authentication.token-broker.type=rsa-key-pair" }
      - matchRegex: { path: 'data["application.properties"]', pattern: "polaris.authentication.token-broker.max-token-generation=PT2H" }
      - matchRegex: { path: 'data["application.properties"]', pattern: "polaris.authentication.token-broker.rsa-key-pair.public-key-file=/deployments/config/public.pem" }
      - matchRegex: { path: 'data["application.properties"]', pattern: "polaris.authentication.token-broker.rsa-key-pair.private-key-file=/deployments/config/private.pem" }

  - it: should configure authentication with symmetric key
    set:
      authentication: { tokenBroker: { type: symmetric-key, secret: { name: polaris-auth } } }
    asserts:
      - matchRegex: { path: 'data["application.properties"]', pattern: "polaris.authentication.authenticator.type=default" }
      - matchRegex: { path: 'data["application.properties"]', pattern: "polaris.authentication.token-service.type=default" }
      - matchRegex: { path: 'data["application.properties"]', pattern: "polaris.authentication.token-broker.type=symmetric-key" }
      - matchRegex: { path: 'data["application.properties"]', pattern: "polaris.authentication.token-broker.max-token-generation=PT1H" }
      - matchRegex: { path: 'data["application.properties"]', pattern: "polaris.authentication.token-broker.symmetric-key.file=/deployments/config/symmetric.key" }

  - it: should derive HTTP ports from service configuration
    set:
      service: { ports: [ { port: 8080 } ] }
      managementService: { ports: [ { port: 8081 } ] }
    asserts:
      - matchRegex: { path: 'data["application.properties"]', pattern: "quarkus.http.port=8080" }
      - matchRegex: { path: 'data["application.properties"]', pattern: "quarkus.management.port=8081" }

  - it: should configure console logging
    set:
      logging: { level: DEBUG, console: { enabled: true, threshold: INFO, format: custom } }
    asserts:
      - matchRegex: { path: 'data["application.properties"]', pattern: "quarkus.log.level=DEBUG" }
      - matchRegex: { path: 'data["application.properties"]', pattern: "quarkus.log.console.enable=true" }
      - matchRegex: { path: 'data["application.properties"]', pattern: "quarkus.log.console.level=INFO" }
      - matchRegex: { path: 'data["application.properties"]', pattern: "quarkus.log.console.format=custom" }

  - it: should configure file logging
    set:
      logging: { file: { enabled: true, threshold: DEBUG, format: custom, logsDir: /mnt/logs, fileName: custom.log, rotation: { maxFileSize: 50Mi, maxBackupIndex: 2, fileSuffix: .yyyy-MM-dd } } }
    asserts:
      - matchRegex: { path: 'data["application.properties"]', pattern: "quarkus.log.file.enable=true" }
      - matchRegex: { path: 'data["application.properties"]', pattern: "quarkus.log.file.level=DEBUG" }
      - matchRegex: { path: 'data["application.properties"]', pattern: "quarkus.log.file.path=/mnt/logs/custom.log" }
      - matchRegex: { path: 'data["application.properties"]', pattern: "quarkus.log.file.rotation.max-file-size=52428800" }
      - matchRegex: { path: 'data["application.properties"]', pattern: "quarkus.log.file.rotation.max-backup-index=2" }
      - matchRegex: { path: 'data["application.properties"]', pattern: "quarkus.log.file.rotation.file-suffix=.yyyy-MM-dd" }

  - it: should disable logging
    set:
      logging: { file: { enabled: false }, console: { enabled: false } }
    asserts:
      - matchRegex: { path: 'data["application.properties"]', pattern: "quarkus.log.file.enable=false" }
      - matchRegex: { path: 'data["application.properties"]', pattern: "quarkus.log.console.enable=false" }

  - it: should enable JSON logging
    set:
      logging: { file: { enabled: true, json: true }, console: { enabled: true, json: true } }
    asserts:
      - equal:
          path: data
          value:
            polaris-server.yml: |-
              authenticator:
                class: org.apache.polaris.service.auth.TestInlineBearerTokenPolarisAuthenticator
              callContextResolver:
                type: default
              cors:
                allowed-credentials: true
                allowed-headers:
                - '*'
                allowed-methods:
                - PATCH
                - POST
                - DELETE
                - GET
                - PUT
                allowed-origins:
                - http://localhost:8080
                allowed-timing-origins:
                - http://localhost:8080
                exposed-headers:
                - '*'
                preflight-max-age: 600
              defaultRealms:
              - default-realm
              featureConfiguration:
                ENFORCE_PRINCIPAL_CREDENTIAL_ROTATION_REQUIRED_CHECKING: false
                SUPPORTED_CATALOG_STORAGE_TYPES:
                - S3
                - S3_COMPATIBLE
                - GCS
                - AZURE
                - FILE
              io:
                factoryType: default
              logging:
                appenders:
                - logFormat: '%-5p [%d{ISO8601} - %-6r] [%t] [%X{aid}%X{sid}%X{tid}%X{wid}%X{oid}%X{srv}%X{job}%X{rid}]
                    %c{30}: %m %kvp%n%ex'
                  threshold: ALL
                  type: console
                level: INFO
                loggers:
                  org.apache.iceberg.rest: DEBUG
                  org.apache.polaris: DEBUG
              maxRequestBodyBytes: -1
              metaStoreManager:
                type: in-memory
              oauth2:
                type: test
              rateLimiter:
                type: no-op
              realmContextResolver:
                type: default
              server:
                adminConnectors:
                - port: 8182
                  type: http
                applicationConnectors:
                - port: 8181
                  type: http
                maxThreads: 200
                minThreads: 10
                requestLog:
                  appenders:
                  - type: console
  - it: should set config map data (auto sorted)
    set:
      polarisServerConfig:
        server:
          maxThreads: 200
          minThreads: 10
          applicationConnectors:
          - type: http
            port: 8181
          adminConnectors:
          - type: http
            port: 8182
          requestLog:
            appenders:
            - type: console
        featureConfiguration:
          ENFORCE_PRINCIPAL_CREDENTIAL_ROTATION_REQUIRED_CHECKING: false
          SUPPORTED_CATALOG_STORAGE_TYPES:
          - S3
        callContextResolver:
          type: default
        realmContextResolver:
          type: default
        defaultRealms:
        - default-realm
        metaStoreManager:
          type: eclipse-link
          persistence-unit: polaris
          conf-file: /eclipselink-config/conf.jar!/persistence.xml
        io:
          factoryType: default
        oauth2:
          type: default
        tokenBroker:
          type: symmetric-key
          secret: polaris
        authenticator:
          class: org.apache.polaris.service.auth.DefaultPolarisAuthenticator
        cors:
          allowed-origins:
          - http://localhost:8080
          allowed-timing-origins:
          - http://localhost:8080
          allowed-methods:
          - PATCH
          - POST
          - DELETE
          - GET
          - PUT
          allowed-headers:
          - "*"
          exposed-headers:
          - "*"
          preflight-max-age: 600
          allowed-credentials: true
        logging:
          level: INFO
          loggers:
            org.apache.iceberg.rest: INFO
            org.apache.polaris: INFO
          appenders:
          - type: console
            threshold: ALL
            logFormat: "%-5p [%d{ISO8601} - %-6r] [%t] [%X{aid}%X{sid}%X{tid}%X{wid}%X{oid}%X{srv}%X{job}%X{rid}] %c{30}: %m %kvp%n%ex"
        maxRequestBodyBytes: -1
        rateLimiter:
          type: no-op
    asserts:
      - matchRegex: { path: 'data["application.properties"]', pattern: "polaris.tasks.max-concurrent-tasks=10" }
      - matchRegex: { path: 'data["application.properties"]', pattern: "polaris.tasks.max-queued-tasks=20" }
